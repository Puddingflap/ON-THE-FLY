<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ASTER OID</title>
  <style>
    :root{
      --bg:#070b14; --fg:#e8f0ff; --accent:#6ee7ff; --accent2:#ffcc6e; --danger:#ff6e6e; --muted:#6b7280; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1200px 800px at 70% 20%, rgba(110,231,255,.06), transparent), var(--bg);
      color:var(--fg); font-family: system-ui, sans-serif; overflow:hidden;
    }
    #wrap{position:fixed; inset:0; display:grid; place-items:center}
    canvas{ width: min(100vw, 100vh*0.5625); height: min(100vh, 100vw/0.5625); max-width:100vw; max-height:100vh; box-shadow: var(--shadow); border-radius: 18px; background: transparent; }
    .hud{position:fixed; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;}
    .panel{pointer-events:auto; position:absolute; top:24px; left:50%; transform:translateX(-50%); background: rgba(8,12,22,.6); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px); padding:10px 14px; border-radius:14px; display:flex; gap:18px; align-items:center}
    .panel .pill{background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.3px}
    .panel .sep{opacity:.3}
    .btn{
      pointer-events:auto; position:absolute; bottom:24px; left:50%; transform:translateX(-50%); background:linear-gradient(180deg, rgba(110,231,255,.18), rgba(110,231,255,.12));
      border:1px solid rgba(110,231,255,.4); color:var(--fg); font-weight:700; letter-spacing:.3px;
      padding:12px 18px; border-radius:14px; box-shadow: var(--shadow); text-decoration:none;
    }
    .hint{position:absolute; bottom:86px; left:50%; transform:translateX(-50%); color:var(--muted); font-size:14px}
    .title{position:absolute; top:50%; left:50%; transform:translate(-50%, -60%); text-align:center}
    h1{margin:0 0 6px 0; font-size: clamp(28px, 6vw, 48px)}
    .subtitle{opacity:.75}
    .toast{position:absolute; top:14px; right:14px; background:rgba(255,110,110,.12); border:1px solid rgba(255,110,110,.35); color:#ffd3d3; padding:8px 12px; border-radius:12px; font-size:12px}
    .stageOverlay{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:48px; font-weight:700; text-align:center;
      text-shadow:0 0 12px rgba(110,231,255,.8);
      opacity:0; transition:opacity 0.5s;
      pointer-events:none;
    }
    .stageOverlay.show{opacity:1;}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="1280" height="720" aria-label="ASTER OID"></canvas>
  </div>
  <div class="hud" aria-live="polite">
    <div class="panel" id="scorePanel" hidden>
      <span class="pill">Mcap $: <span id="score">0B</span></span>
      <span class="sep">•</span>
      <span class="pill">Best: <span id="best">0</span></span>
      <span class="sep">•</span>
      <span class="pill">Logos: <span id="logosCollected">0</span></span>
    </div>
    <div class="title" id="title">
      <h1>ASTER OID</h1>
      <div class="subtitle">Tap/Click or press <strong>SPACE</strong> to boost</div>
    </div>
    <div class="hint" id="hint">Tip: stay centered, read the gaps, boost at the last moment. ASTER OID</div>
    <button class="btn" id="startBtn" aria-label="Start game (or press space)">Start</button>
    <div class="toast" id="pauseToast" hidden>Game paused (tab not active)</div>
    <div class="stageOverlay" id="stageOverlay"></div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  /* --- muziek --- */
  const music = new Audio('assets/intro.mp3');
  music.loop = true;
  let musicStarted = false;
  function startMusic(){ if(!musicStarted){ music.play().catch(()=>{}); musicStarted = true; } }
  window.addEventListener('pointerdown', startMusic);
  window.addEventListener('keydown', e => { if(['Space','ArrowUp','KeyW'].includes(e.code)) startMusic(); });

  /* --- speler-sprite --- */
  const SPRITE_SRC = 'assets/cz-droid.png';
  const spriteImg = new Image(); spriteImg.src = SPRITE_SRC;

  /* --- LOGO PNGs --- */
  const LOGO_FILES = ['assets/logo1.png','assets/logo2.png','assets/logo3.png','assets/logo4.png'];
  const logoImages = LOGO_FILES.map(src => { const im = new Image(); im.src = src; return im; });
  const getRandomLoadedLogo = () => {
    const loaded = logoImages.filter(im => im.complete && im.naturalWidth);
    return loaded.length ? loaded[Math.floor(Math.random()*loaded.length)] : null;
  };

  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function resize(){ const r = canvas.getBoundingClientRect(); canvas.width=Math.round(r.width*DPR); canvas.height=Math.round(r.height*DPR); }
  resize(); window.addEventListener('resize', () => { clearTimeout(resize._t); resize._t=setTimeout(resize,100); });

  // --- wereld ---
  const G=2600, FLAP_VY=-850, MAX_DROP=1200;
  let PIPE_GAP=290, PIPE_SPACING=420, SCROLL_SPEED=180, ACCEL=0;
  const PIPE_W=120, MARGIN_TOP=60;
  const AST = { r:28, x:200, y:300 };

  // --- stages ---
  const STAGES = [
    "Orbit Entry","Meme Belt","Shitcoin Storm","Liquidity Void","Market Crash Zone",
    "CZ’s Wrath","Bear Market Abyss","Asteroid Season","To the Moon","Final Impact"
  ];

  // --- states ---
  let state='start'; 
  let score=0, best=+(localStorage.getItem('flappy-asteroid-best')||0);
  let tPrev=0, speed=SCROLL_SPEED, paused=false; // alleen voor tab-visibility
  let canFlap=true, currentStage=1, pipesPassed=0, logosCollected=0;
  let overlayActive = false; // stage-overlay safe window actief?

  const ui={
    scorePanel:document.getElementById('scorePanel'), score:document.getElementById('score'),
    best:document.getElementById('best'), logosCollected:document.getElementById('logosCollected'),
    startBtn:document.getElementById('startBtn'), title:document.getElementById('title'),
    hint:document.getElementById('hint'), pauseToast:document.getElementById('pauseToast'),
    titleH1:document.querySelector('#title h1'), stageOverlay:document.getElementById('stageOverlay')
  };
  ui.best.textContent=best; ui.logosCollected.textContent=logosCollected;

  function setUI(){
    const isStartOrDead = state==='start' || state==='dead';
    ui.title.style.display = isStartOrDead ? '' : 'none';
    ui.hint.style.display  = isStartOrDead ? '' : 'none';
    ui.startBtn.style.display = isStartOrDead ? '' : 'none';
    ui.scorePanel.hidden = state!=='playing' && state!=='dead';
    if (state==='start') ui.titleH1.style.display='none'; else ui.titleH1.style.display='';
  }

  // --- sterren ---
  const stars = Array.from({length:160},()=>({x:Math.random()*canvas.width,y:Math.random()*canvas.height,z:0.3+Math.random()*0.7,r:0.6+Math.random()*1.8}));

  // --- intro ---
  const intro = { active:false, t0:0, dur:1800, from:{x:0,y:0,diam:0}, to:{x:AST.x,y:AST.y,diam:AST.r*2} };
  function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }

  // --- glow ---
  let glowStrength = 0;

  // --- speler ---
  const player = {
    x:AST.x, y:AST.y, r:AST.r, vy:0, rot:0,
    flap(){
      if(!canFlap || state!=='playing') return;
      this.vy=FLAP_VY;
      glowStrength = 1.0;         // alleen glow, geen flash
      canFlap=false; setTimeout(()=>canFlap=true,150);
    },
    update(dt){
      if(state!=='playing') return;
      this.vy=Math.min(this.vy+G*dt,MAX_DROP);
      this.y+=this.vy*dt;
      this.rot=Math.max(-0.6, Math.min(0.9, this.vy/900));
      glowStrength = Math.max(0, glowStrength - dt*1.5);
    },
    drawAt(x,y,diamPx){
      ctx.save();
      ctx.translate(x*DPR,y*DPR);
      if(state==='playing') ctx.rotate(this.rot);

      if (glowStrength > 0) {
        const g = ctx.createRadialGradient(0,0,this.r*DPR*0.5, 0,0,this.r*DPR*2.2);
        g.addColorStop(0, `rgba(110,231,255,${0.40*glowStrength})`);
        g.addColorStop(1, 'rgba(110,231,255,0)');
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(0,0,this.r*DPR*2.2,0,Math.PI*2);
        ctx.fill();
      }

      if (spriteImg.complete && spriteImg.naturalWidth){
        const iw=spriteImg.naturalWidth, ih=spriteImg.naturalHeight;
        const scale=Math.min((diamPx*DPR)/iw,(diamPx*DPR)/ih);
        const dw=iw*scale, dh=ih*scale;
        ctx.drawImage(spriteImg,-dw/2,-dh/2,dw,dh);
      }
      ctx.restore();
    },
    draw(){ this.drawAt(this.x, this.y, this.r*2); }
  };

  // --- obstakels & LOGO's ---
  const pipes=[], coins=[], explosions=[];
  const LOGO_CHANCE=0.2, LOGO_SIZE=22, LOGO_GAP=100, LOGO_SCORE_BONUS=5;

  function resetPipes(){ pipes.length=0; coins.length=0; explosions.length=0; pipesPassed=0; for(let i=0;i<8;i++) addObstacle(); }
  function addObstacle(){
    const lastX = pipes.length + coins.length ? Math.max(pipes.at(-1)?.x ?? -Infinity, coins.at(-1)?.x ?? -Infinity) : canvas.width/DPR + 300;
    const x = lastX + PIPE_SPACING;
    if (Math.random()<LOGO_CHANCE){
      const gapY = MARGIN_TOP + Math.random()*(canvas.height/DPR - 2*MARGIN_TOP - LOGO_GAP);
      coins.push({ x, y:gapY+LOGO_GAP/2, r:LOGO_SIZE, collected:false, img:getRandomLoadedLogo(), wobbleSeed:Math.random()*Math.PI*2 });
      PIPE_SPACING += LOGO_GAP;
    } else {
      const gapY = MARGIN_TOP + Math.random()*(canvas.height/DPR - 2*MARGIN_TOP - PIPE_GAP);
      pipes.push({x, gapY, passed:false}); PIPE_SPACING=420;
    }
  }

  function addExplosion(x,y){ explosions.push({x,y,startTime:performance.now(),duration:500,maxRadius:50}); }

  // --- input ---
  function boost(){
    if (state==='start') beginIntro();
    else if (state==='dead') restart();
    else if (state==='playing') player.flap();
  }
  window.addEventListener('keydown', e => { if(['Space','ArrowUp','KeyW'].includes(e.code)){ e.preventDefault(); boost(); } if(e.code==='KeyR') restart();});
  window.addEventListener('pointerdown', e => { if (e.target===canvas) boost(); });
  document.getElementById('startBtn').addEventListener('click', boost);

  document.addEventListener('visibilitychange', ()=>{ paused=document.hidden; document.getElementById('pauseToast').hidden=!paused; });

  // --- state transitions ---
  function beginIntro(){
    const cx = (canvas.width/DPR)*0.5;
    const cy = (canvas.height/DPR)*0.42;
    const bigDiam = Math.min(canvas.height/DPR, canvas.width/DPR) * 0.45;
    intro.from = { x:cx, y:cy, diam:bigDiam };
    intro.to   = { x:AST.x, y:AST.y, diam:AST.r*2 };
    intro.active = true; intro.t0 = performance.now(); state='intro';
    ui.titleH1.style.display='none';
    ui.startBtn.style.display='none';
  }
  function startGame(){
    state='playing'; score=0; speed=SCROLL_SPEED; tPrev=0; currentStage=1;
    player.x=AST.x; player.y=AST.y; player.vy=0; canFlap=true;
    PIPE_GAP=290; logosCollected=0; ui.logosCollected.textContent=0; resetPipes(); setUI();
    showStageOverlay(currentStage);
  }
  function gameOver(){
    state='dead';
    best=Math.max(best,score); localStorage.setItem('flappy-asteroid-best',best); ui.best.textContent=best;
    ui.titleH1.textContent='Game Over'; ui.titleH1.style.display='';
    ui.hint.textContent='Press SPACE or click to restart'; ui.startBtn.textContent='Restart'; setUI();
  }
  function restart(){
    state='start'; speed = SCROLL_SPEED; tPrev = 0; canFlap = true;
    pipes.length = 0; coins.length = 0; explosions.length = 0; pipesPassed = 0;
    ui.titleH1.textContent='ASTER OID'; ui.startBtn.textContent='Start'; setUI();
  }

  function showStageOverlay(stageNum){
    if(stageNum<1 || stageNum>STAGES.length) return;
    const name = STAGES[stageNum-1];
    ui.stageOverlay.textContent = `Stage ${stageNum}: ${name}`;
    ui.stageOverlay.classList.add("show");
    overlayActive = true;                   // safe window: game loopt door, maar geen obstakels
    setTimeout(()=>{ ui.stageOverlay.classList.remove("show"); overlayActive = false; }, 2000);
  }

  // --- update ---
  function update(dt){
    if (state==='intro' || paused) return;

    if (state==='playing'){
      // Stage-advance
      if(pipesPassed>=10 && currentStage<STAGES.length){
        currentStage++; pipesPassed=0; speed = SCROLL_SPEED + (currentStage-1)*10;
        resetPipes();
        showStageOverlay(currentStage);
      }

      speed += ACCEL*dt*100;
      player.update(dt);
      const move = speed*dt;

      // Tijdens overlayActive: geen pipes/coins/collisions, speler en achtergrond lopen door
      if (!overlayActive){
        // pipes
        for(const p of pipes){ p.x -= move; }
        for(let i=0;i<pipes.length;i++){
          const p=pipes[i];
          if(!p.passed && player.x>p.x+PIPE_W/2){ p.passed=true; score++; pipesPassed++; ui.score.textContent=score; }
          if(p.x+PIPE_W<-80){ pipes.shift(); addObstacle(); i--; }
        }
        // coins
        for(let i=0;i<coins.length;i++){
          const c=coins[i]; c.x -= move;
          const dx=player.x-c.x, dy=player.y-c.y, d=Math.hypot(dx,dy);
          if(d<player.r+c.r && !c.collected){
            c.collected=true; score+=LOGO_SCORE_BONUS; logosCollected++; ui.logosCollected.textContent=logosCollected; ui.score.textContent=score; addExplosion(c.x,c.y);
          }
          if(c.x+c.r<-80){ coins.splice(i,1); i--; }
        }
        // collisions met pipes
        for(const p of pipes){
          const inX = player.x+player.r>p.x && player.x-player.r<p.x+PIPE_W;
          if(inX && (player.y-player.r<p.gapY || player.y+player.r>p.gapY+PIPE_GAP)) return gameOver();
        }
      }

      // Rand-collisions altijd actief
      if(player.y-player.r<0 || player.y+player.r>canvas.height/DPR) return gameOver();
    }
  }

  // --- draw ---
  function draw(){
    // achtergrond
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#091224'); g.addColorStop(1,'#05070f'); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

    // sterren (achtergrond beweegt ook tijdens overlay)
    for(const s of stars){
      const bgSpeed = (state==='start' || state==='intro') ? 30 : speed;
      s.x -= (bgSpeed * s.z * 0.08) * (1/60) * DPR;
      if(s.x < -2){ s.x=canvas.width+Math.random()*40; s.y=Math.random()*canvas.height; s.z=0.3+Math.random()*0.7; }
      ctx.globalAlpha=0.5 + s.z*0.5;
      ctx.beginPath(); ctx.arc(s.x,s.y,s.r*DPR,0,Math.PI*2); ctx.fillStyle='#e8f0ff'; ctx.fill();
    }
    ctx.globalAlpha=1;

    // Obstakels en logo's: NIET tekenen tijdens overlayActive
    if ((state==='playing' || state==='dead') && !overlayActive){
      for(const p of pipes){
        const x=p.x*DPR, w=PIPE_W*DPR, gy=p.gapY*DPR, gh=PIPE_GAP*DPR;
        drawRockColumn(x,0,w,gy,true);
        drawRockColumn(x,gy+gh,w,canvas.height-(gy+gh),false);
      }
      const t = performance.now() * 0.002;
      for(const c of coins){
        if(c.collected) continue;
        ctx.save();
        const wobble = Math.sin(t + (c.wobbleSeed||0)) * 3;
        ctx.translate(c.x*DPR, (c.y + wobble)*DPR);
        if (c.img && c.img.complete && c.img.naturalWidth){
          const iw=c.img.naturalWidth, ih=c.img.naturalHeight;
          const target = c.r*2*DPR;
          const scale = Math.min(target/iw, target/ih);
          const dw = iw*scale, dh = ih*scale;
          ctx.globalAlpha = 0.25; ctx.beginPath(); ctx.arc(0,0,(c.r+6)*DPR,0,Math.PI*2); ctx.fillStyle='#00e5ff'; ctx.fill(); ctx.globalAlpha = 1;
          ctx.drawImage(c.img, -dw/2, -dh/2, dw, dh);
        }
        ctx.restore();
      }
      const now=performance.now();
      for(let i=explosions.length-1;i>=0;i--){
        const e=explosions[i], el=(now-e.startTime)/e.duration;
        if(el>=1){ explosions.splice(i,1); }
        else{ const r=e.maxRadius*el, a=1-el; ctx.beginPath(); ctx.arc(e.x*DPR,e.y*DPR,r*DPR,0,Math.PI*2); ctx.fillStyle=`rgba(255,165,0,${a})`; ctx.fill(); }
      }
    }

    // speler
    if (state==='start'){
      const cx=(canvas.width/DPR)*0.5, cy=(canvas.height/DPR)*0.42;
      const bigDiam=Math.min(canvas.height/DPR, canvas.width/DPR)*0.45;
      player.drawAt(cx, cy, bigDiam);
    } else if (state==='intro'){
      const tt = Math.min(1, (performance.now()-intro.t0)/intro.dur);
      const p = easeInOutCubic(tt);
      const ix = intro.from.x + (intro.to.x - intro.from.x)*p;
      const iy = intro.from.y + (intro.to.y - intro.from.y)*p;
      const id = intro.from.diam + (intro.to.diam - intro.from.diam)*p;
      player.drawAt(ix, iy, id);
      if (tt>=1){ intro.active=false; startGame(); }
    } else {
      player.draw();
    }
  }

  function drawRockColumn(x,y,w,h,fromTop){
    ctx.save(); ctx.beginPath();
    const step=32*DPR, rough=18*DPR, start=y, end=y+h;
    ctx.moveTo(x,start);
    for(let yy=start; yy<=end; yy+=step){ const off=(Math.sin(yy*0.03)*0.5 + Math.random() * 0.5)*rough; ctx.lineTo(x + (fromTop?off:-off) + w, Math.min(yy+step,end)); }
    ctx.lineTo(x,end); ctx.closePath();
    const rock=ctx.createLinearGradient(x,y,x+w,y); rock.addColorStop(0,'#2a2f3e'); rock.addColorStop(1,'#101420');
    ctx.fillStyle=rock; ctx.fill(); ctx.strokeStyle='rgba(232,240,255,0.05)'; ctx.lineWidth=2*DPR; ctx.stroke(); ctx.restore();
  }

  function loop(ts){
    if(paused){ tPrev=ts; requestAnimationFrame(loop); return; }
    const dt=Math.min(0.033,(tPrev?(ts-tPrev)/1000:0.016)); tPrev=ts;
    update(dt); draw(); requestAnimationFrame(loop);
  }
  setUI(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>


