<script>
(() => {
  const introOverlay = document.getElementById('introOverlay');
  const introStart   = document.getElementById('introStart');
  const introMusic   = document.getElementById('introMusic');
  const countdown    = document.getElementById('countdown');
  const countNum     = document.getElementById('countNum');
  const startBtn     = document.getElementById('startBtn'); // jouw bestaande startknop

  let musicArmed = false;   // na 1e user gesture mogen we audio starten
  let zooming    = false;   // guard tegen dubbel starten

  // 1) Muziek 'bij openen' (legaal): arm na 1e interactie ergens op de pagina
  function armMusicOnce() {
    if (musicArmed) return;
    musicArmed = true;
    introMusic.volume = 0.0;
    const p = introMusic.play();
    if (p) {
      p.then(() => fadeTo(introMusic, 0.6, 600)).catch(() => {/* nog geblokkeerd? ook goed */});
    }
  }
  ['pointerdown','keydown','touchstart'].forEach(ev =>
    document.addEventListener(ev, armMusicOnce, { once:true, passive:true })
  );

  // volume fade helper
  function fadeTo(audio, target, ms=400) {
    const step = 50;
    const diff = target - audio.volume;
    const delta = diff / (ms/step);
    return new Promise(resolve => {
      const it = setInterval(() => {
        const next = audio.volume + delta;
        if ((delta>0 && next>=target) || (delta<0 && next<=target)) {
          audio.volume = target; clearInterval(it); resolve();
        } else {
          audio.volume = Math.max(0, Math.min(1, next));
        }
      }, step);
    });
  }

  // 2) START – knop of SPACE → fade muziek, zoom, daarna countdown en game
  function handleStart() {
    if (zooming) return;
    zooming = true;

    fadeTo(introMusic, 0, 300).then(() => introMusic.pause());

    document.body.classList.add('zooming'); // pauzeer animaties + zoom img + fade overlay

    setTimeout(runCountdown, 1400);
  }

  introStart.addEventListener('click', handleStart);
  window.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); handleStart(); }
  });

  // 3) 3-2-1 DESTROY → klik jouw bestaande startknop
  function runCountdown() {
    introOverlay.style.display = 'none';
    countdown.style.display = 'grid';

    let n = 3;
    countNum.textContent = n;

    const tick = setInterval(() => {
      n--;
      if (n > 0) {
        countNum.textContent = n;
        countNum.style.animation = 'none';
        countNum.offsetHeight;           // reflow om animatie te resetten
        countNum.style.animation = '';
      } else {
        clearInterval(tick);
        countNum.textContent = 'DESTROY';
        setTimeout(() => {
          countdown.style.display = 'none';
          if (startBtn) startBtn.click(); // start jouw game exact zoals nu
          document.body.classList.remove('zooming');
        }, 400);
      }
    }, 750);
  }
})();
</script>
